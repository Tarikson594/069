<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Frankfurt Jump & Run â€“ Iteration 5.10 (Kombinierter Score)</title>
  <style>
    body,html{margin:0;padding:0;height:100%;background:#0b0d14;color:#fff;font-family:sans-serif}
    canvas{display:block;width:100%;height:100%;background:#bfe6ff}
    #hud{position:absolute;left:12px;top:12px;z-index:5;display:flex;gap:10px;align-items:center;background:rgba(10,15,30,.6);border:1px solid #263355;border-radius:10px;padding:6px 10px}
    #hud .badge{background:rgba(20,30,55,.7);border:1px solid #30426f;padding:4px 8px;border-radius:8px;font-weight:700}
    #dialog{position:absolute;left:50%;top:18%;transform:translateX(-50%);z-index:10;background:#0f152a;border:1px solid #2b3f72;border-radius:12px;display:none;max-width:min(760px,92vw)}
    #dialog header{padding:10px 14px;border-bottom:1px solid #22335c;font-weight:800}
    #dialog .content{padding:12px 14px;line-height:1.45}
    #dialog .choices{padding:0 14px 14px;display:flex;flex-direction:column;gap:8px}
    #dialog button{background:#182246;color:#e9ecff;border:1px solid #2d3b70;padding:10px 12px;border-radius:10px;cursor:pointer;text-align:left}
    #dialog button:hover{background:#1f2b57}
    .overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(6,10,20,.72);z-index:20;text-align:center;padding:20px}
    .panel{background:#0f1426;border:1px solid #2c365e;border-radius:14px;padding:18px;text-align:center;max-width:min(680px,92%)}
    .panel h1{margin:.2em 0;font-size:28px}
    .panel p{opacity:.95}
    .btn{background:#182246;color:#e9ecff;border:1px solid #2d3b70;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700}
    #highscores{text-align:left;margin-top:10px;padding:0;list-style:none}
    #highscores li{padding:4px 0;border-bottom:1px solid #2c365e;font-size:14px}
  </style>
</head>
<body>
  <canvas id="game" width="960" height="540"></canvas>
  <div id="hud">
    <span class="badge" id="money">â‚¬100</span>
    <span class="badge" id="karma">Karma:0</span>
  </div>
  <div id="dialog">
    <header>Entscheidung</header>
    <div class="content" id="dlgText"></div>
    <div class="choices" id="dlgChoices"></div>
  </div>
  <div id="endOL" class="overlay">
    <div class="panel">
      <h1>Ostend erreicht ðŸŽ‰</h1>
      <p id="endSummary">Zusammenfassung</p>
      <ul id="highscores"></ul>
      <button class="btn" id="btnRestart">Nochmal spielen</button>
    </div>
  </div>
<script>
(() => {
  const canvas=document.getElementById('game');
  const ctx=canvas.getContext('2d');
  const hudMoney=document.getElementById('money');
  const hudKarma=document.getElementById('karma');
  const dialog=document.getElementById('dialog');
  const dlgText=document.getElementById('dlgText');
  const dlgChoices=document.getElementById('dlgChoices');
  const endOL=document.getElementById('endOL');
  const endSummary=document.getElementById('endSummary');
  const highscores=document.getElementById('highscores');
  document.getElementById('btnRestart').onclick=()=>location.reload();

  const world={width:4400,height:canvas.height,groundY:460};
  const plats=[{x:0,y:world.groundY,w:1200,h:120},{x:1200,y:world.groundY,w:420,h:120},{x:1650,y:world.groundY,w:560,h:120},{x:2250,y:world.groundY,w:520,h:120},{x:2850,y:world.groundY,w:1400,h:120}];

  const player={x:60,y:world.groundY-56,w:30,h:40,vx:0,vy:0,onGround:false,money:100,karma:0};
  let cameraX=0;

  const goal={x:4200,y:world.groundY-60,w:60,h:60};let gameEnded=false;
  let startTime=Date.now();

  const triggers=[
    {id:'beggar',x:620,text:'Bahnhofsviertel: â€ž4 â‚¬ nach GieÃŸenâ€¦ ehrlich!â€œ',choices:[
      {label:'4 â‚¬ geben (Karma+)',fn:()=>{money(-4);karma(+1);} },
      {label:'Ablehnen (Karma-)',fn:()=>{karma(-1);} }
    ]},
    {id:'colleague',x:1750,text:'Kollege: â€žWeinfest, nur ein Glas 10 â‚¬!â€œ',choices:[
      {label:'Mitgehen (âˆ’10 â‚¬)',fn:()=>{money(-10);} },
      {label:'Ablehnen',fn:()=>{} }
    ]},
    {id:'cafe',x:2950,text:'CafÃ©: â€žFlat White? 15 â‚¬.â€œ',choices:[
      {label:'Nehmen (âˆ’15 â‚¬)',fn:()=>{money(-15);} },
      {label:'Nein',fn:()=>{} }
    ]}
  ];
  const fired=new Set();
  let dialogOpen=false;

  function openDialog(tr){
    dialogOpen=true;dialog.style.display='block';
    dlgText.textContent=tr.text;dlgChoices.innerHTML='';
    tr.choices.forEach(ch=>{
      const b=document.createElement('button');
      b.textContent=ch.label;
      b.onclick=()=>{ch.fn();fired.add(tr.id);closeDialog();};
      dlgChoices.appendChild(b);
    });
  }
  function closeDialog(){dialog.style.display='none';dialogOpen=false;}

  const GRAVITY=1800,MOVE=260,JUMP=-620;
  const keys=new Set();
  addEventListener('keydown',e=>{keys.add(e.key.toLowerCase());});
  addEventListener('keyup',e=>keys.delete(e.key.toLowerCase()));

  function aabb(a,b){return a.x<b.x+b.w&&a.x+a.w>b.x&&a.y<b.y+b.h&&a.y+a.h>b.y;}
  function money(d){player.money=Math.max(0,player.money+d);hudMoney.textContent='â‚¬'+player.money;}
  function karma(d){player.karma+=d;hudKarma.textContent='Karma:'+player.karma;}

  function update(dt,t){
    if(gameEnded)return;
    let move=0;if(keys.has('a')||keys.has('arrowleft'))move-=1;if(keys.has('d')||keys.has('arrowright'))move+=1;
    player.vx=move*MOVE;
    const jump=keys.has(' ')||keys.has('w')||keys.has('arrowup');if(jump&&player.onGround){player.vy=JUMP;player.onGround=false;}
    player.vy+=GRAVITY*dt;player.x+=player.vx*dt;player.y+=player.vy*dt;

    player.onGround=false;
    for(const p of plats){if(aabb(player,p)){const prevY=player.y-player.vy*dt;if(prevY+player.h<=p.y+4){player.y=p.y-player.h;player.vy=0;player.onGround=true;}else{if(player.x+player.w/2<p.x+p.w/2)player.x=p.x-player.w;else player.x=p.x+p.w;player.vx=0;}}}

    player.x=Math.max(0,Math.min(world.width-player.w,player.x));
    const lead=120*Math.sign(player.vx);const targetCam=Math.max(0,Math.min(world.width-canvas.width,player.x-canvas.width/2+lead));cameraX+=(targetCam-cameraX)*0.12;

    if(!dialogOpen){for(const tr of triggers){if(fired.has(tr.id))continue;const bx=tr.x,by=world.groundY-40,bw=40,bh=40;if(aabb(player,{x:bx,y:by,w:bw,h:bh})){openDialog(tr);break;}}}
    if(aabb(player,goal)&&!gameEnded){
      gameEnded=true;
      const timeTaken=Math.round((Date.now()-startTime)/1000);
      const score=player.money+(player.karma*10)-timeTaken;
      endSummary.textContent=`Geld: â‚¬${player.money} Â· Karma: ${player.karma} Â· Zeit: ${timeTaken}s Â· Score: ${score}`;
      // Highscore speichern
      let scores=JSON.parse(localStorage.getItem('scores')||'[]');
      scores.push({money:player.money,karma:player.karma,time:timeTaken,score:score});
      if(scores.length>5) scores=scores.slice(-5);
      // Sortieren nach Score
      scores.sort((a,b)=>b.score-a.score);
      localStorage.setItem('scores',JSON.stringify(scores));
      highscores.innerHTML=scores.map(s=>`<li>â‚¬${s.money} Â· Karma ${s.karma} Â· ${s.time}s Â· Score ${s.score}</li>`).join('');
      endOL.style.display='flex';
    }
  }

  function drawPlatforms(){for(const p of plats){ctx.fillStyle='#e6e2d3';ctx.fillRect(p.x-cameraX,p.y,p.w,p.h);ctx.fillStyle='#c9c3b1';ctx.fillRect(p.x-cameraX,p.y-4,p.w,4);}}
  function drawPlayer(){ctx.fillStyle='red';ctx.fillRect(player.x-cameraX,player.y,player.w,player.h);}
  function drawGoal(){const gx=goal.x-cameraX,gy=goal.y;ctx.fillStyle='#4dff88';ctx.fillRect(gx,gy,goal.w,goal.h);ctx.fillStyle='black';ctx.fillText('Ziel',gx+10,gy+35);}
  function drawEventBlocks(t){for(const tr of triggers){if(fired.has(tr.id))continue;const bx=tr.x-cameraX,by=world.groundY-40;const bob=Math.sin(t/420+tr.x)*4;ctx.fillStyle='#ffd24d';ctx.strokeStyle='#a07a1b';ctx.lineWidth=3;ctx.fillRect(bx,by+bob,40,40);ctx.strokeRect(bx,by+bob,40,40);ctx.fillStyle='#1b1b1b';ctx.font='bold 24px sans-serif';ctx.fillText('?',bx+12,by+28+bob);}}

  function render(ts){ctx.clearRect(0,0,canvas.width,canvas.height);ctx.fillStyle='#bfe6ff';ctx.fillRect(0,0,canvas.width,canvas.height);drawPlatforms();drawGoal();drawEventBlocks(ts||0);drawPlayer();}

  let last=0;function loop(ts){const dt=Math.min(0.033,(ts-last)/1000||0.016);last=ts;update(dt,ts);render(ts);requestAnimationFrame(loop);}requestAnimationFrame(loop);
})();
</script>
</body>
</html>