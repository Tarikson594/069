<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Frankfurt Jump & Run – Iteration 4.7 (Parallax + Figur + Events)</title>
  <meta name="theme-color" content="#0b0d14" />
  <style>
    body,html{margin:0;padding:0;height:100%;background:#0b0d14;color:#fff;}
    canvas{display:block;margin:0 auto;background:#b0d9ff;width:100%;height:100%;}
    #hud{position:absolute;top:10px;left:10px;z-index:5;background:rgba(0,0,0,0.4);padding:6px 10px;border-radius:8px;font-family:sans-serif}
    #msg{position:absolute;top:50px;left:10px;z-index:5;font-family:sans-serif;}
    #dialog{position:absolute;top:20%;left:50%;transform:translateX(-50%);z-index:10;background:#222;padding:12px;border-radius:12px;display:none;max-width:90%;}
    #dialog .choices{margin-top:10px;display:flex;flex-direction:column;gap:6px;}
    #dialog button{padding:8px 12px;border-radius:8px;background:#444;color:#fff;border:none;cursor:pointer;text-align:left;}
  </style>
</head>
<body>
  <canvas id="game" width="960" height="540"></canvas>
  <div id="hud">
    <span id="money">€100</span> · <span id="karma">Karma:0</span>
  </div>
  <div id="msg"></div>
  <div id="dialog">
    <div id="dlgText"></div>
    <div class="choices" id="dlgChoices"></div>
  </div>
<script>
(() => {
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');

  // Kamera & Welt
  let cameraX=0;
  const world={ width:4400,height:540, groundY:460 };

  // Spieler
  const player={ x:60,y:world.groundY-56,w:30,h:40,vx:0,vy:0,onGround:false, money:100, karma:0, animTime:0,facing:1 };

  // Sprites laden (eigene Figur)
  let playerFrames=[new Image(),new Image()];
  let spriteReady=false;
  playerFrames[0].src='img/sprite1.png';
  playerFrames[1].src='img/sprite2.png';
  let loaded=0;
  playerFrames.forEach(img=>{ img.onload=()=>{loaded++; if(loaded===2) spriteReady=true;}; });
  const spriteScale=1.6, spriteFootAlign=56;

  // Parallax Layer
  const bgClouds=new Image(); bgClouds.src='img/clouds.png';
  const bgSkyline=new Image(); bgSkyline.src='img/skyline.png';

  function drawParallax(img,factor){
    if(!img.complete||img.naturalWidth===0) return;
    const offset=-cameraX*factor;
    const w=img.width,h=img.height;
    const scale=canvas.height/h;
    let startX=(offset%(w*scale));
    if(startX>0) startX-=w*scale;
    for(let x=startX;x<canvas.width;x+=w*scale){
      ctx.drawImage(img,x,0,w*scale,canvas.height);
    }
  }

  // Events
  const msgEl=document.getElementById('msg');
  const dlg=document.getElementById('dialog');
  const dlgText=document.getElementById('dlgText');
  const dlgChoices=document.getElementById('dlgChoices');
  const hudMoney=document.getElementById('money');
  const hudKarma=document.getElementById('karma');

  const fired=new Set();
  const triggers=[
    {id:'beggar',x:620,r:60,text:'Bahnhofsviertel: „4 € nach Gießen… ehrlich!“',choices:[{label:'4 € geben',fn:()=>{money(-4);karma(+1);say('Du spendest 4 €');}},{label:'Ablehnen',fn:()=>{karma(-1);say('Er murmelt was von Digitalgeld');}}]},
    {id:'colleague',x:1750,r:60,text:'Kollege: „Weinfest, nur ein Glas 10 €!“',choices:[{label:'Mitgehen',fn:()=>{money(-10);say('War nett.');}},{label:'Ablehnen',fn:()=>{say('Er ist enttäuscht');}}]},
    {id:'cafe',x:2950,r:70,text:'Café: Flat White 15 €',choices:[{label:'Nehmen',fn:()=>{money(-15);say('Koffein-Kick');}},{label:'Nein',fn:()=>{say('Du bleibst wachsam');}}]},
  ];

  function openDialog(tr){
    dlg.style.display='block';
    dlgText.textContent=tr.text;
    dlgChoices.innerHTML='';
    tr.choices.forEach(ch=>{
      const b=document.createElement('button');
      b.textContent=ch.label;
      b.onclick=()=>{ch.fn();fired.add(tr.id);closeDialog();};
      dlgChoices.appendChild(b);
    });
  }
  function closeDialog(){ dlg.style.display='none'; }
  function checkTriggers(){
    for(const tr of triggers){
      if(fired.has(tr.id)) continue;
      if(Math.abs(player.x-tr.x)<tr.r){ openDialog(tr); return; }
    }
  }

  // Hilfsfunktionen
  function money(d){player.money+=d;hudMoney.textContent='€'+player.money;}
  function karma(d){player.karma+=d;hudKarma.textContent='Karma:'+player.karma;}
  function say(t){msgEl.textContent=t;setTimeout(()=>{if(msgEl.textContent===t)msgEl.textContent='';},4000);}

  // Eingaben
  const keys=new Set();
  window.addEventListener('keydown',e=>{keys.add(e.key.toLowerCase());});
  window.addEventListener('keyup',e=>{keys.delete(e.key.toLowerCase());});

  // Update & Render
  const GRAVITY=1800,JUMP=-620,MOVE=260;
  function update(dt){
    let move=0;
    if(keys.has('arrowleft')||keys.has('a')) move-=1;
    if(keys.has('arrowright')||keys.has('d')) move+=1;
    player.vx=move*MOVE;
    if((keys.has(' ')||keys.has('w')||keys.has('arrowup'))&&player.onGround){player.vy=JUMP;player.onGround=false;}
    player.vy+=GRAVITY*dt;
    player.x+=player.vx*dt;player.y+=player.vy*dt;
    if(player.y>world.groundY-56){player.y=world.groundY-56;player.vy=0;player.onGround=true;}
    if(player.vx>0) player.facing=1; else if(player.vx<0) player.facing=-1;
    cameraX+=(player.x-canvas.width/2-cameraX)*0.1;
    checkTriggers();
    if(Math.abs(player.vx)>5) player.animTime+=dt; else player.animTime=0;
  }

  function drawPlayer(x,y){
    if(spriteReady){
      const moving=Math.abs(player.vx)>5;
      const idx=moving?Math.floor((player.animTime/0.12)%2):0;
      const img=playerFrames[idx];
      const scale=spriteScale*(spriteFootAlign/(img.naturalHeight||spriteFootAlign));
      const dw=(img.naturalWidth||30)*scale;
      const dh=(img.naturalHeight||spriteFootAlign)*scale;
      const dx=Math.round(x+player.w/2-dw/2);
      const dy=Math.round((y+player.h)-dh);
      ctx.save();
      if(player.facing===-1){ctx.translate(dx+dw/2,0);ctx.scale(-1,1);ctx.translate(-(dx+dw/2),0);} 
      ctx.drawImage(img,dx,dy,dw,dh);
      ctx.restore();
    } else {
      ctx.fillStyle='#ff5733';
      ctx.fillRect(x,y,player.w,player.h);
    }
  }

  function render(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    drawParallax(bgClouds,0.2);
    drawParallax(bgSkyline,0.5);
    ctx.fillStyle='#dcd6c9';ctx.fillRect(0,world.groundY,canvas.width,80);
    drawPlayer(player.x-cameraX,player.y);
  }

  let last=0;
  function loop(ts){const dt=(ts-last)/1000;last=ts;update(dt);render();requestAnimationFrame(loop);} requestAnimationFrame(loop);
})();
</script>
</body>
</html>